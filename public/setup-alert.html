<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Setup Alert</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  body { font-family: Arial,sans-serif; margin: 20px; background: #f5f6fa; color: #222; position: relative; }
  h2 { margin-bottom: 20px; }
  .container {
  display: flex;
  gap: 30px;
  align-items: flex-start; /* keep items aligned at the top */
  flex-wrap: wrap;
}
  .movie-card { display: flex; flex-direction: column; width: 245px; border-radius: 8px; overflow: hidden; box-shadow: 0 6px 18px rgba(15,23,42,0.08); background: #fff; }
  .movie-card img { width: 100%; height: 335px; object-fit: cover; background: #ddd; }
  .card-body { padding: 12px; display: flex; flex-direction: column; gap: 6px; }
  .movie-title { font-size: 18px; font-weight: 600; }
  .movie-sub { font-size: 14px; color: #666; }
  .alert-form { display: flex; flex-direction: column; gap: 15px; background: #fff; padding: 21px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); width: 250px; }
  .alert-form label { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
  .alert-form input { padding: 10px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; outline: none; transition: all 0.2s ease; background: #fff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); }
  .alert-form input:hover { border-color: #ff3b3b; }
  .alert-form input:focus { border-color: #ff3b3b; box-shadow: 0 0 5px rgba(255,59,59,0.3); background: #fff; }
  .alert-form button { width: 100%; padding: 10px 0; border-radius: 6px; border: none; font-size: 14px; font-weight: 600; background: #ff3b3b; color: #fff; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(255,59,59,0.2); }
  .alert-form button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255,59,59,0.25); }


  /* Modal styles */
  .modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999;
  }
  .modal-content {
    background: #fff; padding: 20px; border-radius: 8px; width: 320px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }
  .modal-content h3 { margin-top: 0; }
  .modal-content select {
    width: 100%; margin-bottom: 15px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
  }
  .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
  .modal-buttons button {
    padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer;
  }
  .close-btn { background: #ccc; }
  .save-btn { background: #ff3b3b; color: #fff; }

  /* Top-right buttons */
  .top-buttons { position: absolute;  right: 10px; display: flex; gap: 8px; }
  .top-buttons button { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; }
  .logout-btn { background: #ff3b3b; color: #fff; }
  .reset-btn { background: #222; color: #fff; }
  .top-buttons button:hover { transform: translateY(-2px); opacity: 0.9; }

  /* Venue search results */
  #venueResults { margin-top: 6px; max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
  .venue-result { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
  .venue-result:hover { background: #f0f0f0; }
  
  <!-- âœ… Toast Notification -->
   #toast {
    visibility: hidden;
    min-width: 220px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 12px 16px;
    position: fixed;
    z-index: 1000;
    right: 30px;
    bottom: 30px;
    font-size: 14px;
    opacity: 0;
    transition: opacity 0.4s ease, bottom 0.4s ease;
  }
  #toast.show {
    visibility: visible;
    opacity: 1;
    bottom: 50px;
  }
</style>
</head>
<body>

<div class="top-buttons">
 <!-- <button class="reset-btn" onclick="resetPassword()">Reset Password</button> -->
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<h2>ðŸ“Œ Setup Alert</h2>
<div class="container">
  <div id="movieContainer"></div>
  <div class="alert-form">
    <label for="alertDate">Select alert date:</label>
    <input type="text" id="alertDate" placeholder="Select date" />
	
	  <!-- Language & Format Field -->
    <label>Select Language & Format:</label>
    <button type="button" id="openLangBtn">Choose Language & Format</button>
    <div id="selectedLangFormat" style="font-size:13px;color:#444;"></div>
	
    <label for="venue">Select venue:</label>
    <div style="display: flex; gap: 8px; align-items: center;">
      <input type="text" id="venue" placeholder="Search Venue" />
      <button id="searchVenueBtn" type="button" style="background-color: red; border: none; padding: 8px;"">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" fill="white" viewBox="0 0 24 24">
    <path d="M10 2a8 8 0 0 1 6.32 12.906l4.387 4.387a1 1 0 0 1-1.414 1.414l-4.387-4.387A8 8 0 1 1 10 2zm0 2a6 6 0 1 0 0 12a6 6 0 0 0 0-12z"/>
  </svg>
</button>

    </div>
    <div id="venueResults"></div>

    <button id="saveAlertBtn">Save Alert</button>
	<div id="alertMessage" style="font-size: 13px; margin-top: 8px;"></div>
  </div>
</div>

<!-- Modal for Language & Format -->
<div class="modal" id="langModal">
  <div class="modal-content">
    <h3>Select Language & Format</h3>
    <select id="languageSelect"><option value="">Loading...</option></select>
    <select id="formatSelect"><option value="">Select format</option></select>
    <div class="modal-buttons">
      <button class="close-btn" id="closeModal">Cancel</button>
      <button class="save-btn" id="saveLang">Save</button>
    </div>
  </div>
</div>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
function logout() { localStorage.clear(); window.location.replace("login.html"); }
// function resetPassword() { window.location.href = "reset-password.html"; }

if(localStorage.getItem("loggedIn") !== "true") window.location.replace("login.html");

const movieContainer = document.getElementById("movieContainer");
const alertInput = document.getElementById("alertDate");
const selectedMovie = JSON.parse(localStorage.getItem("selectedMovie") || "{}");

// Helper: format date in YYYY-MM-DD local
const formatDateLocal = d => {
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
};

if (!selectedMovie.ctaUrl) {
  movieContainer.textContent = "âš ï¸ Invalid movie data.";
} else {
  fetch('/api/movie-details', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(selectedMovie)
  })
  .then(res => res.json())
  .then(data => {
    const releaseText = data.releaseDate || 'TBA';

    const imgHtml = `
      <img src="${data.img}" alt="${data.title}" loading="lazy"
           onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'245\\' height=\\'335\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%23ddd\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' font-family=\\'Arial\\' font-size=\\'18\\' fill=\\'%23666\\'>No Image</text></svg>'" />
    `;

    movieContainer.innerHTML = `
      <div class="movie-card">
        ${imgHtml}
        <div class="card-body">
          <div class="movie-title">${data.title}</div>
          <div class="movie-sub">Release Date: ${releaseText}</div>
        </div>
      </div>
    `;

    let releaseDate = new Date(releaseText);
    if (isNaN(releaseDate)) releaseDate = new Date();

    const today = new Date();
    const maxDays = 9;
    let minDate, maxDate;

    if (releaseDate < today) {
      minDate = today;
      maxDate = new Date();
      maxDate.setDate(today.getDate() + maxDays);
    } else {
      minDate = releaseDate;
      maxDate = new Date(releaseDate);
      maxDate.setDate(releaseDate.getDate() + maxDays);
    }

    // Initialize Flatpickr
    flatpickr(alertInput, {
      dateFormat: "Y-M-d",
      minDate: minDate,
      maxDate: maxDate,
      defaultDate: minDate,
      disableMobile: true,
      onValueUpdate: function(selectedDates) {
        if(selectedDates.length > 0){
          const d = selectedDates[0];
          const yyyy = d.getFullYear();
          const month = d.toLocaleString('en-US', { month: 'short' });
          const day = String(d.getDate()).padStart(2, '0');
          alertInput.value = `${yyyy}-${month}-${day}`;
        }
      }
    });

  })
  .catch(err => {
    console.error(err);
    movieContainer.textContent = "âš ï¸ Failed to fetch movie details.";
  });
}

// ===== Language & Format Modal Logic =====
const langModal = document.getElementById("langModal");
const openLangBtn = document.getElementById("openLangBtn");
const closeModal = document.getElementById("closeModal");
const saveLang = document.getElementById("saveLang");
const languageSelect = document.getElementById("languageSelect");
const formatSelect = document.getElementById("formatSelect");
const selectedLangFormatDiv = document.getElementById("selectedLangFormat");

// open modal
openLangBtn.addEventListener("click", async () => {
  langModal.style.display = "flex";
  languageSelect.innerHTML = "<option>Loading...</option>";
  formatSelect.innerHTML = "<option>Select format</option>";

  try {
    const response = await fetch('/api/language', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ctaUrl: selectedMovie.ctaUrl })
    });
    const data = await response.json();
    languageData = data;

// Handle available_languages
if (data.available_languages && Array.isArray(data.available_languages)) {

  // Populate language dropdown
  languageSelect.innerHTML = data.available_languages
    .map(l => `<option value="${l.language}">${l.language}</option>`)
    .join("");

  // When a language is selected, populate format dropdown
  languageSelect.onchange = () => {
    const selectedLang = languageSelect.value;
    const langObj = data.available_languages.find(l => l.language === selectedLang);

    if (langObj && langObj.formats && Array.isArray(langObj.formats)) {
      formatSelect.innerHTML = langObj.formats
        .map(f => `<option value="${f.eventCode}">${f.dimension}</option>`)
        .join("");
    } else {
      formatSelect.innerHTML = "<option disabled>No formats available</option>";
    }
  };

  // Trigger initial population for the first language
  if (data.available_languages.length > 0) {
    languageSelect.value = data.available_languages[0].language;
    const firstLangFormats = data.available_languages[0].formats || [];
    formatSelect.innerHTML = firstLangFormats
      .map(f => `<option value="${f.eventCode}">${f.dimension}</option>`)
      .join("");
  }
}
    // Handle preferred_languages + preferred_formats
    else if (data.preferred_languages && data.preferred_formats) {
      languageSelect.innerHTML = data.preferred_languages
        .map(l => `<option value="${l}">${l}</option>`).join("");
      formatSelect.innerHTML = data.preferred_formats
        .map(f => `<option value="${f}">${f}</option>`).join("");
    }
  } catch (err) {
    console.error("Error fetching languages:", err);
    languageSelect.innerHTML = "<option>Error loading data</option>";
  }
});

closeModal.addEventListener("click", () => langModal.style.display = "none");

saveLang.addEventListener("click", () => {
  selectedLang = languageSelect.value;
  selectedFormat = formatSelect.options[formatSelect.selectedIndex]?.text || "";
  if (!selectedLang || !selectedFormat) {
    alert("Please select both language and format.");
    return;
  }
  selectedLangFormatDiv.textContent = `${selectedLang} - ${selectedFormat}`;
  langModal.style.display = "none";
});


// Save Alert button
// Save Alert button
document.getElementById("saveAlertBtn").addEventListener("click", () => {
  const alertDateRaw = alertInput.value;
  const venueInputEl = document.getElementById("venue");

  // Reset previous error styles
  alertInput.style.borderColor = "#ccc";
  venueInputEl.style.borderColor = "#ccc";
  openLangBtn.style.borderColor = "";

  let hasError = false;

  // Highlight missing fields
  if (!alertDateRaw) {
    alertInput.style.borderColor = "red";
    hasError = true;
  }
  if (!selectedLang) {
    openLangBtn.style.borderColor = "red";
    hasError = true;
  }
  if (!venueInputEl.value) {
    venueInputEl.style.borderColor = "red";
    hasError = true;
  }

  if (hasError) return; // stop if any field is missing

  // Convert date to YYYYMMDD
  const [year, monthStr, day] = alertDateRaw.split("-");
  const monthMap = {
    JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
    JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
  };
  const month = monthMap[monthStr.toUpperCase()] || "01";
  const formattedDate = `${year}${month}${day.padStart(2, "0")}`;

  // Determine event code
  let eventCode = null;
  let tempEventCode = null;

  if (languageData?.available_languages) {
    const langObj = languageData.available_languages.find(l => l.language === selectedLang);
if (langObj) {
  const fmtObj = langObj.formats.find(f => f.dimension === selectedFormat);
  if (fmtObj) {
    // Replace the old eventCode in ctaUrl with the new one
    const baseUrl = selectedMovie.ctaUrl.replace(/\/ET\d+$/, `/${fmtObj.eventCode}`);
    eventCode = baseUrl;
  }
}
  } else if (languageData?.preferred_languages) {
    tempEventCode = selectedMovie.ctaUrl;
  }

  const alertData = {
    phone: localStorage.getItem("phone"),
    event_code: eventCode,
    temp_event_code: tempEventCode,
    alert_date: formattedDate, // format yyyymmdd
    venue: venueInputEl.value,
    lang: selectedLang,
    format: selectedFormat
  };

  // Send to backend
const alertMessageEl = document.getElementById("alertMessage");

fetch("/api/save-alert", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(alertData)
})
  .then(res => res.json())
.then(data => {
  if (data.success && data.message.includes("saved")) {
    showToast("âœ… Alert saved successfully!", true);
    setTimeout(() => {
      window.location.href = "index.html";
    }, 2000);
  } else if (data.message && data.message.includes("already")) {
    showToast("âš ï¸ Alert already set for this movie.", false);
  } else {
    showToast("âŒ Failed to save alert.", false);
  }
})
.catch(err => {
  console.error(err);
  showToast("âŒ Error saving alert.", false);
});

 });




// ===== Venue Search Button Logic =====
const searchVenueBtn = document.getElementById("searchVenueBtn");
const venueInput = document.getElementById("venue");
const venueResultsDiv = document.getElementById("venueResults");
const defaultRegion = "KOCH";

searchVenueBtn.addEventListener("click", async () => {
  const query = venueInput.value.trim();
  venueResultsDiv.innerHTML = "";

if (!query) {
  venueInput.style.borderColor = "red";  // highlight field
  venueResultsDiv.innerHTML = '<span style="color: red; font-size: 14px;">Please enter a venue to search.</span>'; 
  return; // stop execution
} else {
  venueInput.style.borderColor = "#ccc"; // reset if not empty
  venueResultsDiv.innerHTML = ""; // clear previous messages
}


  venueResultsDiv.innerHTML = "ðŸ” Searching...";

  try {
    const response = await fetch(`/api/venue_search?r=${defaultRegion}&q=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (!response.ok || !data.movies || data.movies.length === 0) {
      venueResultsDiv.innerHTML = "âš ï¸ No results found.";
      return;
    }

    // Show results as clickable options
    venueResultsDiv.innerHTML = data.movies
      .map(v => `<div class="venue-result">${v.title}</div>`)
      .join("");

    document.querySelectorAll(".venue-result").forEach(el => {
      el.addEventListener("click", () => {
        venueInput.value = el.textContent;
        venueResultsDiv.innerHTML = "";
      });
    });

  } catch (err) {
    console.error(err);
    venueResultsDiv.innerHTML = "âŒ Error fetching venues.";
  }
});

function showToast(message, isSuccess = true) {
  const toast = document.getElementById("toast");
  if (!toast) return; // safety check

  toast.textContent = message;
  toast.style.backgroundColor = isSuccess ? "#28a745" : "#e74c3c"; // green/red
  toast.style.visibility = "visible";
  toast.style.opacity = "1";

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.visibility = "hidden";
  }, 2500);
}

</script>

<!-- Toast container -->
<div id="toast"
  style="
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 14px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    font-size: 16px;
    transform: translateX(-50%);
    transition: visibility 0s, opacity 0.5s ease;
    opacity: 0;">
</div>

</body>
</html>
